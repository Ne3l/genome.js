define("core/Gene", ["require", "exports"], function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var Gene = /** @class */ (function () {
        function Gene(factor) {
            this.factor = factor;
            this.value = Math.random();
        }
        Gene.prototype.get = function () {
            return this.value * this.factor;
        };
        Gene.prototype.mutate = function () {
            this.value = Math.random();
        };
        return Gene;
    }());
    exports.Gene = Gene;
});
define("core/Blueprint", ["require", "exports"], function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var Blueprint = /** @class */ (function () {
        function Blueprint() {
            this.properties = [];
        }
        Blueprint.prototype.add = function (factor, times) {
            if (times === void 0) { times = 1; }
            for (var i = 0; i < times; i += 1) {
                this.properties.push(factor);
            }
        };
        Blueprint.prototype.getProperties = function () {
            return this.properties;
        };
        return Blueprint;
    }());
    exports.Blueprint = Blueprint;
});
define("core/Chromosome", ["require", "exports", "core/Gene"], function (require, exports, Gene_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var Chromosome = /** @class */ (function () {
        function Chromosome(blueprint) {
            if (blueprint === void 0) { blueprint = null; }
            this.genes = [];
            this.fitness = 0;
            if (blueprint) {
                this.initializeGenes(blueprint);
            }
        }
        Chromosome.prototype.initializeGenes = function (blueprint) {
            var _this = this;
            var properties = blueprint.getProperties();
            properties.map(function (property) {
                var gene = new Gene_1.Gene(property);
                _this.genes.push(gene);
            });
        };
        Chromosome.prototype.computeFitness = function (fitnessCalculation) {
            this.fitness = fitnessCalculation(this.genes);
        };
        Chromosome.fromDNA = function (genes) {
            var chromosome = new Chromosome();
            chromosome.genes = [];
            genes.map(function (gene) {
                var geneClone = Chromosome.copyGene(gene);
                chromosome.genes.push(geneClone);
            });
            return chromosome;
        };
        Chromosome.copyGene = function (gene) {
            // @ts-ignore
            return Object.assign(Object.create(Object.getPrototypeOf(gene)), gene);
        };
        Chromosome.prototype.mutate = function () {
            var pivot = Math.floor(Math.random() * this.genes.length);
            this.genes[pivot].mutate();
        };
        Chromosome.prototype.getFitness = function () {
            return this.fitness;
        };
        Chromosome.prototype.getLength = function () {
            return this.genes.length;
        };
        Chromosome.prototype.getGenes = function () {
            return this.genes;
        };
        return Chromosome;
    }());
    exports.Chromosome = Chromosome;
});
define("core/Population", ["require", "exports", "core/Chromosome"], function (require, exports, Chromosome_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var Population = /** @class */ (function () {
        function Population(size, blueprint) {
            this.size = size;
            this.blueprint = blueprint;
            this.chromosomes = [];
            this.bestChromosome = new Chromosome_1.Chromosome();
            this.sumFitness = 0;
            this.mutationRate = 0.01;
            this.stopAt = null;
            this.cutOff = 0.3;
            this.initializeChromosomes();
        }
        Population.prototype.initializeChromosomes = function () {
            for (var i = 0; i < this.size; i += 1) {
                var chromosome = new Chromosome_1.Chromosome(this.blueprint);
                this.chromosomes.push(chromosome);
            }
        };
        Population.prototype.setFitnessCalculation = function (fitnessCalculation) {
            this.fitnessCalculation = fitnessCalculation;
        };
        Population.prototype.setRender = function (render) {
            this.render = render;
        };
        Population.prototype.setStopAt = function (fitness) {
            this.stopAt = fitness;
        };
        Population.prototype.sortChromosomes = function () {
            this.chromosomes = this.chromosomes.sort(function (a, b) {
                return a.getFitness() > b.getFitness() ? -1 : 1;
            });
        };
        Population.prototype.selectBestChromosomes = function () {
            var _this = this;
            var pivot = Math.floor(this.chromosomes.length * this.cutOff);
            this.chromosomes.splice(this.chromosomes.length - pivot);
            this.sumFitness = 0;
            this.chromosomes.map(function (chromosome) {
                _this.sumFitness += chromosome.getFitness();
            });
        };
        Population.prototype.crossoverChromosomes = function () {
            var newChromosomes = [];
            for (var i = this.chromosomes.length; i < this.size; i += 1) {
                var chromosomeA = null;
                var chromosomeB = null;
                do {
                    chromosomeA = this.getRandomChromosome();
                    chromosomeB = this.getRandomChromosome();
                } while (!chromosomeA || !chromosomeB);
                if (chromosomeA && chromosomeB) {
                    var pivot = Math.floor(Math.random() * chromosomeA.getLength());
                    var genesA = chromosomeA.getGenes().slice(0, pivot);
                    var genesB = chromosomeB.getGenes().slice(pivot);
                    var newChromosome = Chromosome_1.Chromosome.fromDNA(genesA.concat(genesB));
                    newChromosomes.push(newChromosome);
                }
                else {
                    // console.error('Should not happen');
                }
            }
            this.chromosomes = this.chromosomes.concat(newChromosomes);
        };
        Population.prototype.setMutationRate = function (mutationRate) {
            this.mutationRate = mutationRate;
        };
        Population.prototype.setCutOff = function (cutOff) {
            this.cutOff = cutOff;
        };
        Population.prototype.mutateChromosomes = function () {
            var _this = this;
            this.chromosomes.map(function (chromosome) {
                if (Math.random() < _this.mutationRate) {
                    chromosome.mutate();
                }
            });
        };
        Population.prototype.getRandomChromosome = function () {
            var random = Math.random() * this.sumFitness;
            var sumFitness = 0;
            for (var _i = 0, _a = this.chromosomes; _i < _a.length; _i++) {
                var chromosome = _a[_i];
                sumFitness += chromosome.getFitness();
                if (random < sumFitness) {
                    return chromosome;
                }
            }
            return null;
        };
        Population.prototype.shuffleChromosomes = function () {
            this.chromosomes = this.chromosomes.sort(function (a, b) {
                return Math.random() - 0.5;
            });
        };
        Population.prototype.keepBestChromosome = function () {
            if (this.bestChromosome) {
                if (this.bestChromosome.getFitness() < this.chromosomes[0].getFitness()) {
                    this.bestChromosome = this.copyChromosome(this.chromosomes[0]);
                }
            }
            else {
                this.bestChromosome = this.copyChromosome(this.chromosomes[0]);
            }
        };
        Population.prototype.copyChromosome = function (chromosome) {
            // @ts-ignore
            return Object.assign(Object.create(Object.getPrototypeOf(chromosome)), chromosome);
        };
        Population.prototype.run = function (times) {
            if (times === void 0) { times = 1; }
            for (var i = 0; i < times; i += 1) {
                this.process();
                if (this.render) {
                    this.render(this.chromosomes);
                }
                console.log("Generation " + (i + 1) + ": " + this.chromosomes[0].getFitness() + " (remaining: " + this.chromosomes.length + ")");
                this.shuffleChromosomes();
                if (this.stopAt && this.bestChromosome.getFitness() >= this.stopAt) {
                    break;
                }
            }
            var finalString = '';
            this.bestChromosome.getGenes().map(function (gene) {
                finalString += String.fromCharCode(gene.get() + 96);
            });
            console.log("Result (fitness: " + this.bestChromosome.getFitness() + "): " + finalString);
        };
        Population.prototype.process = function () {
            var _this = this;
            this.chromosomes.map(function (chromosome) {
                chromosome.computeFitness(_this.fitnessCalculation);
            });
            this.sortChromosomes();
            this.selectBestChromosomes();
            this.crossoverChromosomes();
            this.mutateChromosomes();
            this.keepBestChromosome();
        };
        return Population;
    }());
    exports.Population = Population;
});
define("example", ["require", "exports", "core/Population", "core/Blueprint"], function (require, exports, Population_1, Blueprint_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var answer = 'helloworldhowareyoutoday';
    var blueprint = new Blueprint_1.Blueprint();
    blueprint.add(26, answer.length);
    var population = new Population_1.Population(500, blueprint);
    population.setMutationRate(0.01);
    population.setCutOff(0.5);
    population.setStopAt(100);
    population.setFitnessCalculation(function (genes) {
        var sum = 1; // Avoid to have 0 on fitness
        for (var i = 0; i < genes.length; i += 1) {
            var charCode = answer.charCodeAt(i) - 96;
            var geneCharCode = Math.floor(genes[i].get());
            if (charCode === geneCharCode) {
                sum += 1;
            }
        }
        return (sum / (genes.length + 1)) * 100;
    });
    // population.setRender((chromosomes: Chromosome[]) => {
    //   let finalString = '';
    //   chromosomes[0].getGenes().map((gene: Gene) => {
    //     finalString += String.fromCharCode(gene.get() + 97);
    //   });
    //   console.log(`Result: ${finalString}`);
    // });
    population.run(3000);
});
define("main", ["require", "exports", "core/Population", "core/Chromosome", "core/Gene", "core/Blueprint"], function (require, exports, Population_2, Chromosome_2, Gene_2, Blueprint_2) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Population = Population_2.Population;
    exports.Chromosome = Chromosome_2.Chromosome;
    exports.Gene = Gene_2.Gene;
    exports.Blueprint = Blueprint_2.Blueprint;
});
